---
variables:
  OUTPUT_ROOT: "${CI_COMMIT_BRANCH}-${CI_COMMIT_SHORT_SHA}"
  OUTPUT_CSV: "${OUTPUT_ROOT}.csv"
  OUTPUT_FPR: "${OUTPUT_ROOT}.fpr"
  OUTPUT_PDF: "${OUTPUT_ROOT}.pdf"
  OUTPUT_XLS: "${OUTPUT_ROOT}.xls"


include:
  - project: '${FORTIFY_CI_TEMPLATE_PROJECT}'
    ref: 'main'
    file: 'templates/fortify-prep-python.yml'

fortify_report-pdf:
  image: ${CONTAINER_REGISTRY}/${FORTIFY_CONTAINER_SCA}
  needs:
    - job: fortify_code-prep_python
      artifacts: true
  script:
    - |-
      #!/bin/bash
      set -euo pipefail
      PATH="/usr/local/bin:${PATH}:/opt/Fortify/bin"
      SCAN_ARGS="${FORTIFY_SCAN_ARGS:-}"
      SCAN_PATH="${FORTIFY_SCAN_PATH:-./**/*}"

      # Generate PDF-based report
      if [[ ! -e ${OUTPUT_FPR} ]]
      then
         echo "FPR file missing"
         exit 1
      elif [[ $( zipinfo "${OUTPUT_FPR}" ) =~ *" 0 bytes uncompressed,"* ]]
      then
         echo "FPR file not valid"
         exit 1
      else
         # Generate PDF report
         BIRTReportGenerator \
           -template "Developer Workbook" \
           -format PDF \
           -source "${OUTPUT_FPR}" \
           -output "${OUTPUT_PDF}"
         ls
      fi
  artifacts:
    # Enable download of container scanning report
    paths:
      - fortify-scan-results.pdf
    expire_in: 1 week
  allow_failure: true

...
