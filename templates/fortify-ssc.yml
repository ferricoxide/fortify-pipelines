---
include:
  - project: '${FORTIFY_CI_TEMPLATE_PROJECT}'
    ref: '${FORTIFY_CI_TEMPLATE_BRANCH}'
    file: 'templates/fortify-ssc-version.yml'
  - project: '${FORTIFY_CI_TEMPLATE_PROJECT}'
    ref: '${FORTIFY_CI_TEMPLATE_BRANCH}'
    file: 'templates/fortify-prep.yml'

fortify_code-prep:
  needs:
    - job: fortify_vers-prep

fortify_push2ssc:
  image: ${CI_REGISTRY}/${FORTIFY_CONTAINER_SCA}
  needs:
    - job: fortify_code-prep
      artifacts: true
  variables:
    SSC_URL: "https://${SSC_URL}"
  script:
    - |-
      #!/bin/bash
      set -euo pipefail
      set -x
      PATH="/usr/local/bin:${PATH}:/opt/Fortify/bin"

      fortifyclient -url "${SSC_URL}" -authtoken "${SSC_TRANSFER_TOKEN}" \
        uploadFPR -file "${OUTPUT_FPR}" -project "${SSC_APP_NAME}" \
        -version "${SSC_APP_VERS:-${CI_BUILD_REF_NAME}}"
  artifacts:
    # Enable download of container scanning report
    paths:
      - ${OUTPUT_FPR}
    expire_in: 1 week
  allow_failure: false

fortify_ssc-export:
  image: ${CI_REGISTRY}/${FORTIFY_CONTAINER_EXPORTER}
  needs:
    - job: fortify_push2ssc
      artifacts: false
  variables:
    export_config: /config/SSCToGitLab.yml
    ssc_baseUrl: "https://${SSC_URL}"
    ssc_authToken: "${SSC_TRANSFER_TOKEN}"
    ssc_version_name: "${SSC_APP_NAME}:${SSC_APP_VERS:-${CI_BUILD_REF_NAME}}"
  script:
    - echo "Script not executed but required for CI-def to pass lint"
  allow_failure: true
  artifacts:
    paths:
      - gl-fortify-sast.json
      - gl-fortify-dast.json
      - gl-fortify-depscan.json
    reports:
      sast: gl-fortify-sast.json
      dast: gl-fortify-dast.json
      dependency_scanning: gl-fortify-depscan.json
...
